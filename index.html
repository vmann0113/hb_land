<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>한빔한복 랜딩</title>
  <link rel="stylesheet" href="style.css?v=20260112-200" />
</head>
<body>

<main class="landing">

  <!-- 01 히어로 -->
  <section class="block">
    <img src="assets/01_hero.png" alt="히어로">
  </section>

  <!-- 02 상담신청(입력폼) -->
  <section class="block block-overlay" id="formSection">
    <img src="assets/02_form.png" alt="상담신청(입력폼)">
    <form class="overlay-layer" id="leadForm" novalidate>
      <input class="ov ov-name" name="name" placeholder="이름을 입력하세요" required autocomplete="name">
      <input class="ov ov-phone" name="phone" placeholder="연락처를 입력하세요" maxlength="13" inputmode="numeric" required autocomplete="tel">

      <select class="ov ov-branch" name="branch" required>
        <option value="" disabled selected>지점을 선택하세요</option>
        <option>부산점</option><option>센텀점</option><option>울산점</option><option>김해점</option>
        <option>양산점</option><option>창원점</option><option>마산점</option><option>진주점</option>
        <option>인천점</option><option>안산점</option><option>대구점(오픈예정)</option><option>포항점(오픈예정)</option>
      </select>

      <input class="ov ov-date" name="date" type="date" required>
      <button class="ov ov-submit" type="submit" aria-label="제출하기"></button>
    </form>
  </section>

  <!-- 03 매장소개 (높이 변경/축소) -->
  <section class="block short">
    <img src="assets/03_store_intro.png" alt="매장소개">
  </section>

  <!-- 04 차별성 (신규 / 투명버튼 포함) -->
  <section class="block block-overlay">
    <img src="assets/04_differentiation.png" alt="차별성">
    <div class="overlay-layer">
      <button class="ov ov-store-cta" type="button" aria-label="상담신청으로 이동"></button>
    </div>
  </section>

  <!-- 05 리뷰 -->
  <section class="block">
    <img src="assets/05_reviews.png" alt="리뷰">
  </section>

  <!-- 06 전국지점 (오버레이) -->
  <section class="block block-overlay stores-map">
    <img src="assets/06_stores.png" alt="전국지점">
    <div class="overlay-layer" id="storesOverlay"></div>
  </section>

  <!-- 07 룩북 -->
  <section class="block">
    <img src="assets/07_lookbook.png" alt="룩북">
  </section>

  <!-- 08 지점별 네이버링크 (오버레이) -->
  <section class="block block-overlay naver-grid">
    <img src="assets/08_naver_links.png" alt="지점별 네이버 예약">
    <div class="overlay-layer" id="naverOverlay"></div>
  </section>

  <!-- 09 푸터 -->
  <section class="block">
    <img src="assets/09_footer.png" alt="푸터">
  </section>

</main>

<!-- ✅ 하단 고정 CTA (이 블록이 있어야 함) -->
<div class="fixed-cta">
  <picture class="cta-picture">
    <source media="(max-width: 600px)" srcset="assets/cta_mobile_750.png">
    <img src="assets/cta_1080.png" alt="상담 예약하기">
  </picture>
  <button class="fixed-cta-click" type="button" aria-label="상담 예약하기"></button>
</div>

<div id="toast" aria-live="polite"></div>

<script>
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyiPaERPD1ZUBNO7T40wR5Tcy0jU0qtw5SRwBylCHAvRSjafqHOLGkAWGhxKyUgCerM/exec".trim();

  // 토스트
  const toast = document.getElementById('toast');
  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toast.classList.remove('show'),2200);
  }

  // ✅ KB FIX: fixed CTA 높이를 CSS 변수로 반영(스크롤/포커스 보정에 사용)
  function setCtaHeightVar(){
    const cta = document.querySelector('.fixed-cta');
    const h = cta ? Math.round(cta.getBoundingClientRect().height) : 0;
    document.documentElement.style.setProperty('--ctaH', h + 'px');
  }
  window.addEventListener('resize', setCtaHeightVar);
  setCtaHeightVar();

  // ✅ KB FIX: 포커스 요소가 키보드/CTA에 가리면 자동으로 올려주는 유틸
  (function KeyboardSafeFocus(){
    const FORM_SECTION_SEL = '#formSection';

    function isEditable(el){
      if(!el) return false;
      const t = (el.tagName || '').toLowerCase();
      return t === 'input' || t === 'textarea' || t === 'select' || el.isContentEditable;
    }

    function getBottomOverlay(){
      // fixed CTA가 화면을 덮고 있으므로, 이 높이만큼 안전 여유로 빼준다
      const cta = document.querySelector('.fixed-cta');
      const ctaH = cta ? cta.getBoundingClientRect().height : 0;
      // 토스트는 pointer-events none이라 실제 가림 영향은 적지만, 약간의 여유는 둠
      return Math.max(16, Math.round(ctaH) + 16);
    }

    function ensureVisible(el){
      if(!isEditable(el)) return;

      // 폼 섹션 안에서만 동작(성공본 보호)
      if(!el.closest(FORM_SECTION_SEL)) return;

      const vv = window.visualViewport;
      const vh = vv ? vv.height : window.innerHeight;

      const r = el.getBoundingClientRect();
      const bottomSafe = vh - getBottomOverlay();
      const topSafe = 12; // 위쪽은 조금만 여유

      // 아래로 가리면 위로 올림
      if (r.bottom > bottomSafe) {
        const dy = (r.bottom - bottomSafe) + 12;
        window.scrollBy({ top: dy, left: 0, behavior: 'smooth' });
        return;
      }
      // 위로 너무 붙으면 살짝 내림
      if (r.top < topSafe) {
        const dy = (topSafe - r.top) + 12;
        window.scrollBy({ top: -dy, left: 0, behavior: 'smooth' });
        return;
      }
    }

    function ensureVisibleTwice(el){
      // 키보드 애니메이션 타이밍 때문에 여러 번 체크하는 게 핵심
      requestAnimationFrame(()=>ensureVisible(el));
      setTimeout(()=>ensureVisible(el), 80);
      setTimeout(()=>ensureVisible(el), 250);
    }

    document.addEventListener('focusin', (e) => {
      ensureVisibleTwice(e.target);
    });

    // 키보드 올라오며 viewport가 줄어드는 타이밍 대응
    if (window.visualViewport) {
      let t = null;
      window.visualViewport.addEventListener('resize', () => {
        clearTimeout(t);
        t = setTimeout(() => ensureVisibleTwice(document.activeElement), 50);
      });
    }

    // 외부에서 호출할 수 있게 노출(CTA 이동 후 focus 직후 보정용)
    window.__ensureFormFieldVisible = ensureVisibleTwice;
  })();

  // 폼 섹션으로 이동
  function goToForm(){
    const sec = document.getElementById('formSection');
    sec.scrollIntoView({behavior:'smooth', block:'start'});

    // 기존 성공본 흐름 유지 + 포커스 후 보정만 추가
    setTimeout(()=>{
      const first = document.querySelector('.ov-name');
      first?.focus();

      // ✅ KB FIX: 포커스 직후(키보드 뜨는 타이밍) 한번 더 보정
      if (first && window.__ensureFormFieldVisible) window.__ensureFormFieldVisible(first);
    }, 450);
  }

  // ✅ 하단 CTA 클릭 → 폼 이동
  document.querySelector('.fixed-cta-click')?.addEventListener('click', goToForm);

  // 차별성 CTA → 폼 이동
  document.querySelector('.ov-store-cta')?.addEventListener('click', goToForm);

  // 연락처 자동 하이픈
  const phone = document.querySelector('.ov-phone');
  phone?.addEventListener('input', ()=>{
    let n = phone.value.replace(/[^0-9]/g,'').slice(0,11);
    phone.value =
      n.length < 4 ? n :
      n.length < 8 ? n.slice(0,3)+'-'+n.slice(3) :
      n.slice(0,3)+'-'+n.slice(3,7)+'-'+n.slice(7);
  });

  // 달력 강제 오픈(showPicker)
  const dateInput = document.querySelector('.ov-date');
  function openDatePicker(){
    try{
      if (dateInput && typeof dateInput.showPicker === 'function') dateInput.showPicker();
      else if (dateInput) { dateInput.focus(); dateInput.click(); }
    }catch(e){
      try { dateInput?.focus(); } catch(_) {}
    }
  }
  dateInput?.addEventListener('click', openDatePicker);
  dateInput?.addEventListener('touchstart', (e)=>{
    e.preventDefault();
    openDatePicker();
  }, {passive:false});

  // ✅ 통합 클릭 집계: 전국지점/네이버링크 어디든 a[data-branch]면 집계
  function sendClick(branchName){
    const payload = JSON.stringify({ type:'click', branch: branchName, ts: Date.now() });
    if (navigator.sendBeacon) navigator.sendBeacon(GAS_WEBAPP_URL, payload);
    else fetch(GAS_WEBAPP_URL, { method:'POST', body: payload, keepalive:true }).catch(()=>{});
  }
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-branch]');
    if(!a) return;
    const branchName = (a.dataset.branch || "").trim();
    if(!branchName) return;
    sendClick(branchName);
  });

  // 지점 12개
  const BRANCHES = [
    { key:"busan",   name:"부산점",  status:"open",   url:"https://m.booking.naver.com/booking/6/bizes/661812" },
    { key:"centum",  name:"센텀점",  status:"open",   url:"https://booking.naver.com/booking/6/bizes/1577219" },
    { key:"ulsan",   name:"울산점",  status:"open",   url:"https://booking.naver.com/booking/6/bizes/1534767" },
    { key:"gimhae",  name:"김해점",  status:"open",   url:"https://booking.naver.com/booking/6/bizes/1402679" },
    { key:"yangsan", name:"양산점",  status:"open",   url:"https://booking.naver.com/booking/13/bizes/868629" },
    { key:"changwon",name:"창원점",  status:"open",   url:"https://booking.naver.com/booking/6/bizes/843111" },
    { key:"masan",   name:"마산점",  status:"open",   url:"https://booking.naver.com/booking/6/bizes/1526541" },
    { key:"jinju",   name:"진주점",  status:"open",   url:"https://m.booking.naver.com/booking/6/bizes/1485854" },
    { key:"incheon", name:"인천점",  status:"open",   url:"https://m.booking.naver.com/booking/13/bizes/1039475" },
    { key:"ansan",   name:"안산점",  status:"open",   url:"https://m.booking.naver.com/booking/6/bizes/1500008" },
    { key:"daegu",   name:"대구점",  status:"coming", url:"" },
    { key:"pohang",  name:"포항점",  status:"coming", url:"" },
  ];

  const STORES_BASE_W = 1080;
  const STORES_RECTS = {
    busan:   { x:567, y:255, w:131, h:131 },
    centum:  { x:712, y:255, w:131, h:131 },
    ulsan:   { x:858, y:255, w:131, h:131 },
    gimhae:  { x:567, y:407, w:131, h:131 },
    yangsan: { x:712, y:407, w:131, h:131 },
    changwon:{ x:858, y:407, w:131, h:131 },
    masan:   { x:567, y:559, w:131, h:131 },
    jinju:   { x:712, y:559, w:131, h:131 },
    incheon: { x:858, y:559, w:131, h:131 },
    ansan:   { x:567, y:709, w:131, h:131 },
    daegu:   { x:712, y:709, w:131, h:131 },
    pohang:  { x:858, y:709, w:131, h:131 },
  };

  const NAVER_BASE_W = 1080;
  const NAVER_BASE_H = 937.2;
  const NAVER_RECTS = {
    busan:   { x: 69, y:225, w:292, h:146 },
    centum:  { x:394, y:225, w:292, h:146 },
    ulsan:   { x:719, y:225, w:292, h:146 },
    gimhae:  { x: 69, y:395, w:292, h:146 },
    yangsan: { x:394, y:395, w:292, h:146 },
    changwon:{ x:719, y:395, w:292, h:146 },
    masan:   { x: 69, y:565, w:292, h:146 },
    jinju:   { x:394, y:565, w:292, h:146 },
    incheon: { x:719, y:565, w:292, h:146 },
    ansan:   { x: 69, y:734, w:292, h:146 },
    daegu:   { x:394, y:734, w:292, h:146 },
    pohang:  { x:719, y:734, w:292, h:146 },
  };

  function makeLink(branch, rect){
    const a = document.createElement('a');
    a.className = "ov";
    a.href = branch.url;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.setAttribute("data-branch", branch.name);
    a.setAttribute("aria-label", `${branch.name} 네이버 예약`);
    a.dataset.x = rect.x; a.dataset.y = rect.y; a.dataset.w = rect.w; a.dataset.h = rect.h;
    return a;
  }

  function makeComing(branch, rect){
    const btn = document.createElement('button');
    btn.type = "button";
    btn.className = "ov";
    btn.setAttribute("aria-label", `${branch.name} 오픈 준비중`);
    btn.dataset.x = rect.x; btn.dataset.y = rect.y; btn.dataset.w = rect.w; btn.dataset.h = rect.h;
    btn.addEventListener('click', ()=> showToast('오픈 준비중입니다.'));
    return btn;
  }

  function applyRectsForSection(sectionSelector, baseW, baseH){
    const sec = document.querySelector(sectionSelector);
    if(!sec) return;

    const img = sec.querySelector('img');
    const overlay = sec.querySelector('.overlay-layer');
    if(!img || !overlay) return;

    const run = ()=>{
      const cw = img.clientWidth || 0;
      const ch = img.clientHeight || 0;
      if(!cw || !ch) return;

      const hBase = (baseH != null) ? baseH : (img.naturalHeight || ch);
      const sx = cw / baseW;
      const sy = ch / hBase;

      overlay.querySelectorAll('.ov').forEach(el=>{
        const x = Number(el.dataset.x || 0);
        const y = Number(el.dataset.y || 0);
        const w = Number(el.dataset.w || 0);
        const h = Number(el.dataset.h || 0);
        el.style.left   = (x * sx) + "px";
        el.style.top    = (y * sy) + "px";
        el.style.width  = (w * sx) + "px";
        el.style.height = (h * sy) + "px";
        el.style.background = "transparent";
        el.style.border = "none";
        el.style.cursor = "pointer";
      });
    };

    if (img.complete) run();
    else img.addEventListener('load', run, { once:true });
  }

  function buildOverlays(){
    const storesWrap = document.getElementById('storesOverlay');
    const naverWrap  = document.getElementById('naverOverlay');
    if(storesWrap) storesWrap.innerHTML = "";
    if(naverWrap)  naverWrap.innerHTML  = "";

    BRANCHES.forEach(b=>{
      if(storesWrap){
        const r = STORES_RECTS[b.key];
        if(r) storesWrap.appendChild(b.status === "open" ? makeLink(b, r) : makeComing(b, r));
      }
      if(naverWrap){
        const r = NAVER_RECTS[b.key];
        if(r) naverWrap.appendChild(b.status === "open" ? makeLink(b, r) : makeComing(b, r));
      }
    });

    applyRectsForSection('.stores-map', STORES_BASE_W, null);
    applyRectsForSection('.naver-grid',  NAVER_BASE_W, NAVER_BASE_H);
  }

  window.addEventListener('resize', ()=>{
    applyRectsForSection('.stores-map', STORES_BASE_W, null);
    applyRectsForSection('.naver-grid',  NAVER_BASE_W, NAVER_BASE_H);
  });

  // 폼 제출(안정형)
  const form = document.getElementById('leadForm');
  const submitBtn = document.querySelector('.ov-submit');
  let submitting = false;

  function getField(name){
    return form?.elements?.namedItem(name) || form?.elements?.[name] || null;
  }

  function validateForm(){
    const nameEl = getField('name');
    const phoneEl = getField('phone');
    const branchEl = getField('branch');
    const dateEl = getField('date');

    if(!nameEl || !phoneEl || !branchEl || !dateEl) {
      return {ok:false, msg:'폼 구성 오류(필드 누락). 새로고침 후 다시 시도해주세요.'};
    }
    if(!nameEl.value.trim()) return {ok:false, msg:'이름을 입력해주세요.'};
    if(!phoneEl.value.trim()) return {ok:false, msg:'연락처를 입력해주세요.'};
    if(!branchEl.value) return {ok:false, msg:'지점을 선택해주세요.'};
    if(!dateEl.value) return {ok:false, msg:'예식일정을 선택해주세요.'};
    return {ok:true};
  }

  function fireAndForgetPost(url, payload){
    return fetch(url, { method:'POST', body: payload, keepalive:true });
  }

  form?.addEventListener('submit', (e)=>{
    e.preventDefault();
    if (submitting) return;

    const v = validateForm();
    if(!v.ok){
      showToast(v.msg);
      return;
    }

    const payload = JSON.stringify({
      type:'lead',
      name: getField('name').value.trim(),
      phone: getField('phone').value.trim(),
      branch: getField('branch').value,
      date: getField('date').value,
      ts: Date.now()
    });

    submitting = true;
    if (submitBtn){
      submitBtn.disabled = true;
      submitBtn.style.pointerEvents = 'none';
    }

    showToast('접수중입니다...');

    const p = fireAndForgetPost(GAS_WEBAPP_URL, payload);

    const doneTimer = setTimeout(()=>{
      showToast('접수 완료되었습니다!');
      form.reset();

      submitting = false;
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.style.pointerEvents = 'auto';
      }
    }, 700);

    p.catch((err)=>{
      clearTimeout(doneTimer);
      console.error(err);
      showToast('전송 실패. 네트워크를 확인하고 다시 시도해주세요.');

      submitting = false;
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.style.pointerEvents = 'auto';
      }
    });
  });

  // start
  buildOverlays();
</script>

</body>
</html>

